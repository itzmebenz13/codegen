<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shein Script Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Courier New', Courier, monospace; }
        .input-area { background-color: #1e293b; border-color: #334155; }
        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="h-screen flex flex-col p-4 overflow-hidden">

    <!-- Header -->
    <header class="mb-4 flex justify-between items-center shrink-0">
        <div>
            <h1 class="text-2xl font-bold text-emerald-400">SHEIN SCRIPT GEN <span class="text-xs text-gray-500">v1.0</span></h1>
            <p class="text-xs text-gray-400">Paste Raw HTTP Request &rarr; Get Python Script</p>
        </div>
        <button onclick="generateScript()" class="btn bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded shadow-lg shadow-emerald-900/50">
            GENERATE CODE
        </button>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 gap-4 min-h-0">
        
        <!-- Left: Input -->
        <div class="flex-1 flex flex-col min-w-0">
            <label class="text-sm font-bold text-gray-400 mb-2 block">PASTE RAW REQUEST HERE (Headers + Body):</label>
            <textarea id="rawInput" class="input-area w-full flex-1 p-4 rounded text-xs leading-relaxed focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-none" placeholder="POST /ph/bff-api/user/email_register...
Host: m.shein.com
...
(Paste the full raw request from your capture tool here)"></textarea>
        </div>

        <!-- Right: Output -->
        <div class="flex-1 flex flex-col min-w-0 relative group">
            <label class="text-sm font-bold text-gray-400 mb-2 block">GENERATED PYTHON SCRIPT:</label>
            <textarea id="outputCode" readonly class="input-area w-full flex-1 p-4 rounded text-xs leading-relaxed text-emerald-300 focus:outline-none resize-none" placeholder="# Generated code will appear here..."></textarea>
            
            <!-- Copy Button -->
            <button onclick="copyOutput()" class="absolute top-9 right-4 bg-gray-700 hover:bg-gray-600 text-white text-xs px-3 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                Copy
            </button>
        </div>
    </div>

    <!-- Logic -->
    <script>
        function parseRawRequest(raw) {
            const lines = raw.trim().split('\n');
            let headers = {};
            let bodyLines = [];
            let isBody = false;
            let method = "POST";
            let url = "";

            // Parsing Loop
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim(); // Don't trim internal spaces yet

                if (i === 0 && (line.startsWith("POST") || line.startsWith("GET"))) {
                    const parts = line.split(" ");
                    method = parts[0];
                    url = "https://m.shein.com" + parts[1].split('?')[0]; // Base URL assumption
                    continue;
                }

                if (line === "") {
                    isBody = true;
                    continue;
                }

                if (!isBody) {
                    // Header Parsing
                    const separator = line.indexOf(":");
                    if (separator > -1) {
                        const key = line.substring(0, separator).trim().toLowerCase();
                        const val = line.substring(separator + 1).trim();
                        headers[key] = val;
                    }
                } else {
                    bodyLines.push(lines[i]); // Keep original formatting for body
                }
            }

            // Extract Form Data
            let formData = {};
            const fullBody = bodyLines.join('\n');
            
            // 1. Multipart Form Data Parsing
            if (fullBody.includes("WebKitFormBoundary")) {
                const parts = fullBody.split(/------WebKitFormBoundary[a-zA-Z0-9]+/);
                parts.forEach(part => {
                    if (part.includes('name="')) {
                        const nameMatch = part.match(/name="([^"]+)"/);
                        if (nameMatch) {
                            const name = nameMatch[1];
                            // Extract content after double newline
                            const contentParts = part.split('\n\n');
                            if (contentParts.length > 1) {
                                let value = contentParts[1].trim();
                                if (value && !value.includes("--")) {
                                    formData[name] = value;
                                }
                            }
                        }
                    }
                });
            } 
            // 2. URL Encoded Parsing
            else if (fullBody.includes("=") && !fullBody.includes("{")) {
                fullBody.split('&').forEach(pair => {
                    const [k, v] = pair.split('=');
                    if (k) formData[k] = decodeURIComponent(v || '');
                });
            }

            return { headers, formData, url };
        }

        function generateScript() {
            const raw = document.getElementById('rawInput').value;
            if (!raw) { alert("Please paste raw request data first."); return; }

            const data = parseRawRequest(raw);
            
            // Clean Headers
            const forbiddenHeaders = ['host', 'connection', 'content-length', 'cookie'];
            let cleanHeaders = {};
            for (const [k, v] of Object.entries(data.headers)) {
                if (!forbiddenHeaders.includes(k)) {
                    cleanHeaders[k] = v;
                }
            }

            // Extract Cookie specifically to handle formatting
            const cookieStr = data.headers['cookie'] || "";

            // Build Python Dictionary Strings
            const headersStr = JSON.stringify(cleanHeaders, null, 4);
            const formDataStr = JSON.stringify(data.formData, null, 4);

            // Template
            const pythonCode = `import requests
import uuid
import time
import json

# ─── AUTO-GENERATED CREDENTIALS ──────────────────>
# Extracted from your raw request
EMAIL    = "${data.formData['email'] || 'ENTER_EMAIL'}"
PASSWORD = "${data.formData['password'] || 'ENTER_PASSWORD'}"

# ─── VOUCHER CODES TO COLLECT ────────────────────>
CODES = [
    "phsf021205", "phsf021206", "phsf021207",
    "phsf021208", "phsf021209", "phsf021210"
]

# ─── PARSED HEADERS ──────────────────────────────>
# Note: Host and Content-Length are handled automatically
BASE_HEADERS = ${headersStr}

# Inject Cookie separately to avoid syntax errors with quotes
BASE_HEADERS['cookie'] = '${cookieStr.replace(/'/g, "\\'")}' 

# ─── LOGIN CONFIGURATION ─────────────────────────>
LOGIN_URL = "${data.url || 'https://m.shein.com/ph/bff-api/user/email_register'}"

# ─── STEP 1: LOGIN ───────────────────────────────>
def login(session):
    print(f"Logging in to {LOGIN_URL}...")
    
    # Form Data Extracted from Raw Body
    form_data = ${formDataStr}

    # Ensure credentials are sync'd if they were found
    if "email" in form_data: form_data["email"] = EMAIL
    if "password" in form_data: form_data["password"] = PASSWORD
    if "password_confirm" in form_data: form_data["password_confirm"] = PASSWORD

    try:
        r = session.post(
            LOGIN_URL,
            params={"_ver": "1.1.8", "_lang": "en"},
            data=form_data,
            headers=BASE_HEADERS,
            timeout=15
        )
        
        try:
            result = r.json()
            if str(result.get("code")) == "0":
                print("✅ Login successful!\\n")
                return True
            else:
                print(f"❌ Login failed: {result.get('msg')}")
                return False
        except:
            print(f"❌ Response was not JSON (Status: {r.status_code})")
            return False

    except Exception as e:
        print(f"❌ Error: {e}")
        return False

# ─── STEP 2: COLLECT VOUCHERS ────────────────────>
def collect_vouchers(session):
    voucher_url = "https://m.shein.com/ph/bff-api/promotion/coupon/package/collect"
    
    # Header Override for JSON payload
    voucher_headers = BASE_HEADERS.copy()
    voucher_headers["Content-Type"] = "application/json"

    print("=" * 60)
    print("Collecting vouchers...")
    print("=" * 60)

    for code in CODES:
        print(f"\\nCollecting: {code}")

        payload = {
            "scene": "home",
            "idempotentCode": str(uuid.uuid4()),
            "couponPackages": [{
                "couponPackageId": "17135535",
                "couponCodes": code,
            }]
        }

        try:
            r = session.post(
                voucher_url,
                params={"_ver": "1.1.8", "_lang": "en"},
                json=payload,
                headers=voucher_headers,
                timeout=10
            )
            res = r.json()
            if str(res.get("code")) == "0":
                print(f"✅ {code} — Success")
            else:
                print(f"❌ {code} — {res.get('msg')}")

        except Exception as e:
            print(f"❌ {code} — Request failed")

        time.sleep(2)

# ─── MAIN ────────────────────────────────────────>
if __name__ == "__main__":
    with requests.Session() as s:
        if login(s):
            collect_vouchers(s)
`;

            document.getElementById('outputCode').value = pythonCode;
        }

        function copyOutput() {
            const copyText = document.getElementById("outputCode");
            copyText.select();
            document.execCommand("copy");
            alert("Python code copied to clipboard!");
        }
    </script>
</body>
</html>
